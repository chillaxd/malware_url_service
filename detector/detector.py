from flask import Flask, jsonify, request
from flask_caching import Cache
from redis_client import RedisClient
import logging

# Logging configuration
FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
logging.basicConfig(level=logging.INFO, format=FORMAT)

app = Flask(__name__)
cache = Cache(app, config={'CACHE_TYPE': 'simple', 'CACHE_THRESHOLD': 1000})


@app.route('/urlinfo/<version>/', defaults={'path_info': ''})
@app.route('/urlinfo/<version>/<path:path_info>', methods=['GET'])
def url_info(version, path_info):
    response_msg = {
        'host': '',
        'path': '',
        'status': '',
    }
    target_host = path_info.split('/')[0]

    if version == "1":
        _response = get_url_info_v1(host=target_host, path=path_info, query_string=request.query_string)

        if _response is not None:
            response_msg = _response
            response_status = 200
        else:
            response_msg['status'] = "backend Not available"
            response_status = 500
    else:
        logging.error("Version %s not available right now.", version)
        response_msg['status'] = "api version not implemented"
        response_status = 404

    return jsonify(response_msg), response_status


@app.route('/urlinfo/update/<version>/', defaults={'path_info': ''})
@app.route('/urlinfo/update/<version>/<path:path_info>', methods=['GET'])
def update_url_store(version, path_info):
    response_msg = {
        'status': '',
    }
    target_host = path_info.split('/')[0]

    if version == "1":
        _response = update_url_store_v1(host=target_host, path=path_info, query_string=request.query_string)

        if _response:
            response_msg['status'] = "Successfully updated"
            response_status = 201
        else:
            response_msg['status'] = "Backend Not available"
            response_status = 500
    else:
        logging.error("Version %s not available right now.", version)
        response_msg['status'] = "api version not implemented"
        response_status = 404

    return jsonify(response_msg), response_status


@cache.memoize(timeout=60)
def get_url_info_v1(host, path, query_string):
    """
    Get the url info from the Redis backend, if it is malware or not
    :param host: suspected url host
    :param path: path with suspected url
    :param query_string: Queury string related to suspected url
    :return: Dict of suspected url with check if it is malware or not
    """
    status = {
        'host': host,
        'path': path,
        'status': ''
    }

    if len(str(query_string)) != 0:
        status['query'] = query_string.decode("utf-8")

    r_client = RedisClient()
    malware_content = r_client.get(key=host)

    if malware_content is not None:
        if malware_content != "ERROR":
            status['stored_info'] = malware_content.decode("utf-8")
            status['status'] = 'blacklisted'
        else:
            return None
    else:
        status['status'] = 'whitelisted'

    return status


def update_url_store_v1(host, path, query_string):
    """
    Update the Redis backend with incoming malware url
    :param host: malware url host
    :param path: path with maleware url
    :param query_string: Queury string related to malware url
    :return: True if successfully updated else False
    """
    url_stat = {
        'host': host,
        'path': path,
    }

    if len(str(query_string)) != 0:
        url_stat['query'] = query_string.decode("utf-8")

    r_client = RedisClient()
    update_done = r_client.set(key=host, value=url_stat)

    logging.info("Malware URL database has been updated with %s : %s", host, update_done)

    return update_done


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8008, threaded=True, debug=True)
